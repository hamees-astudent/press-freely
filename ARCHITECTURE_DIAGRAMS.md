# System Architecture Diagrams

## Key Storage Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Browser localStorage                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                               â”‚
â”‚  contactKeys: {                                               â”‚
â”‚    "user123": {                                               â”‚
â”‚      myPrivateKey: "-----ECDH P-256 Private Key-----"       â”‚
â”‚      myPublicKey:  "-----ECDH P-256 Public Key-----"        â”‚
â”‚      theirPublicKey: "-----ECDH P-256 Public Key-----"      â”‚
â”‚    },                                                         â”‚
â”‚    "user456": {                                               â”‚
â”‚      myPrivateKey: "-----Different Private Key-----"        â”‚
â”‚      myPublicKey:  "-----Different Public Key-----"         â”‚
â”‚      theirPublicKey: "-----Different Public Key-----"       â”‚
â”‚    }                                                          â”‚
â”‚  }                                                            â”‚
â”‚                                                               â”‚
â”‚  myContacts: [                                                â”‚
â”‚    { customId: "user123", username: "Alice", hasKeys: true }â”‚
â”‚    { customId: "user456", username: "Bob", hasKeys: false } â”‚
â”‚  ]                                                            â”‚
â”‚                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Key Exchange Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   User A    â”‚                                    â”‚   User B    â”‚
â”‚  (Alice)    â”‚                                    â”‚   (Bob)     â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚                                                  â”‚
       â”‚ 1. Generate Key Pair A                          â”‚
       â”‚    - Private Key A                              â”‚
       â”‚    - Public Key A                               â”‚
       â”‚                                                  â”‚
       â”‚ 2. Click "Exchange Keys"                        â”‚
       â”‚                                                  â”‚
       â”‚ 3. Send Public Key A â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
       â”‚                                                  â”‚
       â”‚                          4. Modal appears:       â”‚
       â”‚                             "Accept/Reject"      â”‚
       â”‚                                                  â”‚
       â”‚                          5. Generate Key Pair B  â”‚
       â”‚                             - Private Key B      â”‚
       â”‚                             - Public Key B       â”‚
       â”‚                                                  â”‚
       â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 6. Send Public Key B   â”‚
       â”‚                                                  â”‚
       â”‚ 7. Derive Shared Secret                         â”‚
       â”‚    = ECDH(Private A, Public B)                  â”‚
       â”‚                                                  â”‚
       â”‚                          8. Derive Shared Secret â”‚
       â”‚                             = ECDH(Private B,    â”‚
       â”‚                                    Public A)     â”‚
       â”‚                                                  â”‚
       â”‚ Both now have SAME shared secret                â”‚
       â”‚                                                  â”‚
       â”‚ 9. Encrypt with AES-GCM <â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•>â”‚
       â”‚                                                  â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Message Encryption Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Sending Message                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                               â”‚
â”‚  1. User types: "Hello World"                                â”‚
â”‚                                                               â”‚
â”‚  2. Get Contact Keys from localStorage                       â”‚
â”‚     - myPrivateKey                                           â”‚
â”‚     - theirPublicKey                                         â”‚
â”‚                                                               â”‚
â”‚  3. Derive Shared Secret                                     â”‚
â”‚     sharedSecret = ECDH(myPrivateKey, theirPublicKey)       â”‚
â”‚                                                               â”‚
â”‚  4. Encrypt with AES-GCM                                     â”‚
â”‚     iv = random(12 bytes)                                    â”‚
â”‚     ciphertext = AES-GCM.encrypt(plaintext, sharedSecret, iv)â”‚
â”‚                                                               â”‚
â”‚  5. Create JSON                                              â”‚
â”‚     { iv: [1,2,3...], content: [encrypted bytes...] }       â”‚
â”‚                                                               â”‚
â”‚  6. Send via Socket.io                                       â”‚
â”‚     socket.emit("send_message", {                            â”‚
â”‚       text: JSON.stringify({ iv, content })                 â”‚
â”‚     })                                                        â”‚
â”‚                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Receiving Message                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                               â”‚
â”‚  1. Receive from Socket.io                                   â”‚
â”‚     socket.on("receive_message", (data) => ...)             â”‚
â”‚                                                               â”‚
â”‚  2. Get Contact Keys                                         â”‚
â”‚     - myPrivateKey                                           â”‚
â”‚     - theirPublicKey                                         â”‚
â”‚                                                               â”‚
â”‚  3. Derive Shared Secret                                     â”‚
â”‚     sharedSecret = ECDH(myPrivateKey, theirPublicKey)       â”‚
â”‚                                                               â”‚
â”‚  4. Parse JSON                                               â”‚
â”‚     { iv, content } = JSON.parse(data.text)                 â”‚
â”‚                                                               â”‚
â”‚  5. Decrypt with AES-GCM                                     â”‚
â”‚     plaintext = AES-GCM.decrypt(content, sharedSecret, iv)  â”‚
â”‚                                                               â”‚
â”‚  6. Display: "Hello World"                                   â”‚
â”‚                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Component Hierarchy

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          App.js                           â”‚
â”‚  - Manages auth state                                     â”‚
â”‚  - Switches between Login and ChatInterface              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚                     â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    Login.jsx     â”‚  â”‚      ChatInterface.jsx          â”‚
â”‚                  â”‚  â”‚                                  â”‚
â”‚ - Username input â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚ - Passphrase     â”‚  â”‚ â”‚ Nav Rail                     â”‚â”‚
â”‚ - Submit button  â”‚  â”‚ â”‚ - Logo                       â”‚â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â”‚ - User ID display            â”‚â”‚
                      â”‚ â”‚ - Export Keys button         â”‚â”‚
                      â”‚ â”‚ - Import Keys button         â”‚â”‚
                      â”‚ â”‚ - Logout button              â”‚â”‚
                      â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
                      â”‚                                  â”‚
                      â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
                      â”‚ â”‚ Contact List Panel           â”‚â”‚
                      â”‚ â”‚ - Add Contact section        â”‚â”‚
                      â”‚ â”‚ - Search form                â”‚â”‚
                      â”‚ â”‚ - Contact list               â”‚â”‚
                      â”‚ â”‚   - Avatar                   â”‚â”‚
                      â”‚ â”‚   - Online indicator         â”‚â”‚
                      â”‚ â”‚   - ğŸ”’ Key indicator         â”‚â”‚
                      â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
                      â”‚                                  â”‚
                      â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
                      â”‚ â”‚ Chat Box                     â”‚â”‚
                      â”‚ â”‚ - Chat header                â”‚â”‚
                      â”‚ â”‚   - Contact name             â”‚â”‚
                      â”‚ â”‚   - Exchange Keys button     â”‚â”‚
                      â”‚ â”‚   - Call button              â”‚â”‚
                      â”‚ â”‚ - Message list               â”‚â”‚
                      â”‚ â”‚ - Input area                 â”‚â”‚
                      â”‚ â”‚   - Text input               â”‚â”‚
                      â”‚ â”‚   - Mic button               â”‚â”‚
                      â”‚ â”‚   - Send button              â”‚â”‚
                      â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
                      â”‚                                  â”‚
                      â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
                      â”‚ â”‚ Key Exchange Modal (overlay) â”‚â”‚
                      â”‚ â”‚ - Accept button              â”‚â”‚
                      â”‚ â”‚ - Reject button              â”‚â”‚
                      â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
                      â”‚                                  â”‚
                      â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
                      â”‚ â”‚ Status Banner (floating)     â”‚â”‚
                      â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Socket Event Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      WebSocket Events                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Client A                  Server                   Client B
   â”‚                        â”‚                          â”‚
   â”‚â”€â”€user_connectedâ”€â”€â”€â”€â”€â”€â”€>â”‚                          â”‚
   â”‚                        â”‚<â”€â”€â”€â”€â”€user_connectedâ”€â”€â”€â”€â”€â”€â”‚
   â”‚                        â”‚                          â”‚
   â”‚                        â”‚â”€â”€update_user_statusâ”€â”€â”€â”€â”€>â”‚
   â”‚<â”€â”€update_user_statusâ”€â”€â”€â”‚                          â”‚
   â”‚                        â”‚                          â”‚
   â”‚â”€â”€request_key_exchangeâ”€>â”‚                          â”‚
   â”‚                        â”‚â”€â”€key_exchange_requestâ”€â”€â”€>â”‚
   â”‚                        â”‚                          â”‚
   â”‚                        â”‚<â”€â”€respond_key_exchangeâ”€â”€â”€â”‚
   â”‚<â”€â”€key_exchange_responseâ”‚                          â”‚
   â”‚                        â”‚                          â”‚
   â”‚â”€â”€send_messageâ”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                          â”‚
   â”‚                        â”‚â”€â”€receive_messageâ”€â”€â”€â”€â”€â”€â”€â”€>â”‚
   â”‚                        â”‚                          â”‚
   â”‚<â”€â”€receive_messageâ”€â”€â”€â”€â”€â”€â”‚<â”€â”€send_messageâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
   â”‚                        â”‚                          â”‚
   â”‚â”€â”€typingâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                          â”‚
   â”‚                        â”‚â”€â”€display_typingâ”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
   â”‚                        â”‚                          â”‚
   â”‚â”€â”€call_userâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                          â”‚
   â”‚                        â”‚â”€â”€incoming_callâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
   â”‚                        â”‚                          â”‚
   â”‚                        â”‚<â”€â”€answer_callâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
   â”‚<â”€â”€call_acceptedâ”€â”€â”€â”€â”€â”€â”€â”€â”‚                          â”‚
   â”‚                        â”‚                          â”‚
   â”‚â”€â”€end_callâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                          â”‚
   â”‚                        â”‚â”€â”€call_endedâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
   â”‚                        â”‚                          â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Data Flow Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     User Interaction Flow                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

1. Login
   â”Œâ”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ User â”‚â”€â”€â”€â”€>â”‚ Frontend â”‚â”€â”€â”€â”€>â”‚  Server  â”‚
   â””â”€â”€â”€â”€â”€â”€â”˜     â”‚ Login.jsxâ”‚     â”‚ auth.js  â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â”‚
                                      â–¼
                                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                 â”‚ MongoDB â”‚
                                 â”‚ Verify  â”‚
                                 â”‚ User    â”‚
                                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â”‚
                                      â–¼
                                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                 â”‚  JWT    â”‚
                                 â”‚ Token   â”‚
                                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â”‚
                                      â–¼
                                localStorage
                                  "chatUser"

2. Add Contact
   â”Œâ”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ User â”‚â”€â”€â”€â”€>â”‚  Search Form â”‚â”€â”€â”€â”€>â”‚  Server  â”‚
   â””â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚ chat.js  â”‚
                                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                           â”‚
                                           â–¼
                                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                      â”‚ MongoDB â”‚
                                      â”‚ Find    â”‚
                                      â”‚ User    â”‚
                                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                           â”‚
                                           â–¼
                                      localStorage
                                      "myContacts"
                                      hasKeys: false

3. Exchange Keys
   â”Œâ”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ User â”‚â”€â”€â”€â”€>â”‚ Click Buttonâ”‚â”€â”€â”€â”€>â”‚ Generate â”‚
   â”‚  A   â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚ KeyPair  â”‚
   â””â”€â”€â”€â”€â”€â”€â”˜                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                          â”‚
                                          â–¼
                                     localStorage
                                     "contactKeys"
                                          â”‚
                                          â–¼
                                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                     â”‚  Socket  â”‚
                                     â”‚  Emit    â”‚
                                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                          â”‚
                                          â–¼
                                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                     â”‚  Server  â”‚
                                     â”‚  Relay   â”‚
                                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                          â”‚
                                          â–¼
                                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                     â”‚ User B   â”‚
                                     â”‚ Receives â”‚
                                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                          â”‚
                                          â–¼
                                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                     â”‚  Modal   â”‚
                                     â”‚ Accept?  â”‚
                                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                          â”‚
                                      Yes â”‚ No
                                      â”Œâ”€â”€â”€â”´â”€â”€â”€â”
                                      â–¼       â–¼
                                  Generate  Reject
                                  KeyPair
                                      â”‚
                                      â–¼
                                  localStorage
                                  "contactKeys"
                                      â”‚
                                      â–¼
                                  Socket Emit
                                  Response
                                      â”‚
                                      â–¼
                                  User A
                                  Receives
                                      â”‚
                                      â–¼
                                  Save Public
                                  Key
                                      â”‚
                                      â–¼
                                  hasKeys: true

4. Send Message
   â”Œâ”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ User â”‚â”€â”€â”€â”€>â”‚ Type Textâ”‚â”€â”€â”€â”€>â”‚  Derive  â”‚
   â””â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚  Secret  â”‚
                                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                       â”‚
                                       â–¼
                                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                  â”‚ Encrypt  â”‚
                                  â”‚ AES-GCM  â”‚
                                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                       â”‚
                                       â–¼
                                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                  â”‚  Socket  â”‚
                                  â”‚  Emit    â”‚
                                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                       â”‚
                                       â–¼
                                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                  â”‚  Server  â”‚
                                  â”‚  Store   â”‚
                                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                       â”‚
                                       â–¼
                                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                  â”‚ MongoDB  â”‚
                                  â”‚ Messages â”‚
                                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                       â”‚
                                       â–¼
                                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                  â”‚  Socket  â”‚
                                  â”‚  Emit    â”‚
                                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                       â”‚
                                       â–¼
                                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                  â”‚ Receiver â”‚
                                  â”‚ Decrypt  â”‚
                                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                       â”‚
                                       â–¼
                                  Display
```

## Security Model

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Security Layers                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Layer 1: Transport Security
   â”œâ”€ WebSocket over TLS (wss://)
   â”œâ”€ HTTPS for HTTP requests
   â””â”€ JWT token authentication

Layer 2: End-to-End Encryption
   â”œâ”€ ECDH key agreement (P-256 curve)
   â”œâ”€ Per-contact key pairs
   â”œâ”€ AES-GCM encryption (256-bit)
   â””â”€ Random IV per message

Layer 3: Client-Side Storage
   â”œâ”€ Private keys never leave device
   â”œâ”€ Public keys only via WebSocket
   â”œâ”€ Keys in localStorage (browser sandboxed)
   â””â”€ Manual backup/restore

Layer 4: Server-Side Security
   â”œâ”€ JWT verification
   â”œâ”€ Rate limiting
   â”œâ”€ Input validation
   â”œâ”€ No key storage
   â””â”€ Encrypted messages in database

Layer 5: Application Logic
   â”œâ”€ Explicit key exchange (user consent)
   â”œâ”€ Visual indicators
   â”œâ”€ Disabled actions without keys
   â””â”€ Error handling
```

## System State Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Contact Relationship States                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  Not Added  â”‚
        â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
               â”‚
        (Search & Add)
               â”‚
               â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚   Added     â”‚
        â”‚ hasKeys: âŒ â”‚
        â”‚  ğŸ”’ shown   â”‚
        â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
               â”‚
   (Initiate Key Exchange)
               â”‚
               â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  Pending    â”‚
        â”‚ Request Sentâ”‚
        â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
               â”‚
         â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”
    Acceptâ”‚          â”‚Reject
         â–¼           â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚Connected â”‚  â”‚ Rejected â”‚
   â”‚hasKeys:âœ…â”‚  â”‚hasKeys:âŒâ”‚
   â”‚ğŸ”’ hidden â”‚  â”‚Back to   â”‚
   â”‚Can chat  â”‚  â”‚ Added    â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

**Legend:**
- `â”€â”€â”€>` : Data flow
- `<â•â•â•>` : Bidirectional encrypted channel
- `â”Œâ”€â”€â”€â”` : System component
- `â”‚...â”‚` : Container/boundary
- `  â–¼  ` : Sequential step
